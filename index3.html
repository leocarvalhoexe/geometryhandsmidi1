<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Circle and Shape Manipulation</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; }
  </style>
</head>
<body>
  <video id="video" style="display:none;" playsinline></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const videoElement = document.getElementById('video');
    const canvasElement = document.getElementById('canvas');
    const ctx = canvasElement.getContext('2d');

    function resizeCanvas() {
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let circleRadius = 100;
    let shapeSides = 100; // 100 = círculo
    const centerX = () => canvasElement.width / 2;
    const centerY = () => canvasElement.height / 2;

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({ image: videoElement });
      },
      width: 640,
      height: 480
    });
    camera.start();

    const drawLandmarks = (landmarks) => {
      const connections = [
        [0,1],[1,2],[2,3],[3,4],
        [0,5],[5,6],[6,7],[7,8],
        [5,9],[9,10],[10,11],[11,12],
        [9,13],[13,14],[14,15],[15,16],
        [13,17],[17,18],[18,19],[19,20],
        [0,17]
      ];
      ctx.strokeStyle = 'lime';
      ctx.lineWidth = 2;
      for (const [a, b] of connections) {
        const x1 = canvasElement.width - (landmarks[a].x * canvasElement.width);
        const y1 = landmarks[a].y * canvasElement.height;
        const x2 = canvasElement.width - (landmarks[b].x * canvasElement.width);
        const y2 = landmarks[b].y * canvasElement.height;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }
    };

    function distance(x1, y1, x2, y2) {
      const dx = x2 - x1;
      const dy = y2 - y1;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function isTouchingCircle(x, y, cx, cy, r, tolerance = 20) {
      const d = distance(x, y, cx, cy);
      return Math.abs(d - r) <= tolerance;
    }

    function drawShape(cx, cy, radius, sides) {
      ctx.beginPath();
      for (let i = 0; i < sides; i++) {
        const angle = (i / sides) * Math.PI * 2;
        const x = cx + radius * Math.cos(angle);
        const y = cy + radius * Math.sin(angle);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.strokeStyle = 'cyan';
      ctx.lineWidth = 4;
      ctx.stroke();
    }

    function onResults(results) {
      ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      const cx = centerX();
      const cy = centerY();

      // Desenha a forma (círculo ou polígono)
      drawShape(cx, cy, circleRadius, shapeSides);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
          const landmarks = results.multiHandLandmarks[i];
          const handedness = results.multiHandedness[i].label; // "Left" ou "Right"

          drawLandmarks(landmarks); // Desenha esqueleto

          const indexTip = landmarks[8];
          const thumbTip = landmarks[4];

          const ix = canvasElement.width - (indexTip.x * canvasElement.width);
          const iy = indexTip.y * canvasElement.height;
          const tx = canvasElement.width - (thumbTip.x * canvasElement.width);
          const ty = thumbTip.y * canvasElement.height;

          const pinchDistance = distance(ix, iy, tx, ty);
          const pinchX = (ix + tx) / 2;
          const pinchY = (iy + ty) / 2;

          // Mão direita controla o RAIO se a pinça estiver tocando o contorno
          if (handedness === "Right" && isTouchingCircle(ix, iy, cx, cy, circleRadius)) {
            const newRadius = Math.min(Math.max(pinchDistance * 2, 30), 300);
            circleRadius = newRadius;
          }

          // Mão esquerda controla a FORMA se a pinça estiver tocando o contorno
          if (handedness === "Left" && isTouchingCircle(pinchX, pinchY, cx, cy, circleRadius)) {
            // Mapeia distância da pinça para número de lados (3 a 100)
            const newSides = Math.round(Math.min(Math.max((pinchDistance - 10) / 5 + 3, 3), 100));
            shapeSides = newSides;
          }
        }
      }
    }
  </script>
</body>
</html>
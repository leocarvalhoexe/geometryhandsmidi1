<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Shape Manipulator v28</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
    canvas { display: block; }
    #info, #settingsButton, #openOutputPopupButton, #midiToggleButton, #operationModeButton { position: absolute; top: 10px; z-index: 100; padding: 10px; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    #info { left: 10px; }
    #settingsButton { left: 150px; }
    #openOutputPopupButton { left: 320px; }
    #midiToggleButton { left: 510px; }
    #operationModeButton { left: 670px; } /* Positioned after MIDI Toggle button */
    #infoModal, #settingsModal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background-color: #333; color: #fff; padding: 30px; border-radius: 10px; width: 80%; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; }
    .modal-content h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
    .modal-content p, .modal-content ul { line-height: 1.6; }
    .modal-content ul { padding-left: 20px; }
    .modal-content a { color: #00bcd4; text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }
    #closeModal, #closeSettingsModal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
    #closeModal:hover, #closeSettingsModal:hover { color: #fff; }
    .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; text-align: center; font-size: 0.9em; }
    /* Styles for the MIDI output select and its label */
    .modal-content label[for="midiOutputSelect"] { display: block; margin-bottom: 5px; color: #ccc; /* Lighter color for label text */ }
    #midiOutputSelect { width: 100%; padding: 8px; margin-top: 10px; border-radius: 4px; border: 1px solid #555; background-color: #222; color: white; font-size: 1em; }

    #hud {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button id="info">‚ÑπÔ∏è Manual</button>
  <button id="settingsButton">‚öôÔ∏è Configura√ß√µes</button>
  <button id="openOutputPopupButton">‚ÜóÔ∏è Abrir Janela de Sa√≠da</button>
  <button id="midiToggleButton">üéπ MIDI ON</button>
  <button id="operationModeButton">üë§ Modo: 2 Pessoas</button>

  <div id="infoModal">
    <div class="modal-content">
      <span id="closeModal">&times;</span>
      <h3>Manual do Usu√°rio - v28</h3>

      <h4>Explica√ß√£o Geral do Projeto</h4>
      <p>Este projeto (v28) permite a manipula√ß√£o de <strong>duas formas geom√©tricas independentes</strong> e interativas atrav√©s dos movimentos das m√£os (capturados pela webcam, suportando uma ou duas pessoas). Integra essas intera√ß√µes com a gera√ß√£o de m√∫sica em tempo real via MIDI e envia dados via OSC para aplica√ß√µes externas como o TouchDesigner (usando o script `osc_relay28.py`).</p>
      <p><strong>Novidades v28:</strong>
        <ul>
            <li><strong>Modo ARPEGGIO Modificado:</strong> Agora toca todas as notas da forma simultaneamente, como um acorde, em vez de sequencialmente.</li>
            <li><strong>Melhorias OSC:</strong>
                <ul>
                    <li>Reconex√£o autom√°tica ao servidor OSC (WebSocket) no navegador.</li>
                    <li>Envio peri√≥dico de mensagens `/ping` (heartbeat) para manter a conex√£o OSC ativa.</li>
                    <li>O script `osc_relay28.py` agora responde ao navegador confirmando cada mensagem OSC recebida.</li>
                    <li>Envio autom√°tico de estados globais (MIDI, Pulso, Staccato, Puxar V√©rtices, Modo Acorde, Escala) via OSC sempre que s√£o alterados.</li>
                    <li>Envio de mensagens OSC `/forma/[id]/gestureActivated` indicando o gesto de m√£o ativo (resize, sides, pull, liquify, ou none) para cada forma.</li>
                    <li>(Opcional) `osc_relay28.py` pode ser configurado para receber comandos OSC via UDP de softwares externos.</li>
                </ul>
            </li>
            <li>Mant√©m funcionalidades da v27 como modos de acorde (Tr√≠ade/Todos V√©rtices), limite de polifonia, controle de modo de acorde via tecla 'C' e OSC, comunica√ß√£o OSC via WebSocket, e modo "1 Pessoa" atualizado.</li>
        </ul>
      </p>

      <h4>Integra√ß√£o MIDI e Acordes</h4>
      <p>O sistema utiliza a API Web MIDI do navegador. Cada forma possui seu pr√≥prio canal MIDI.</p>
      <ul>
        <li>Notas geradas em diferentes modos (Sequencial, Arpejo - agora como acorde, etc.) com dire√ß√£o revers√≠vel (para Sequencial).</li>
        <li>N√∫mero de lados da forma influencia a sequ√™ncia/acorde.</li>
        <li>Notas mapeadas para escalas harm√¥nicas (tecla 'S').</li>
        <li>Tamanho da forma (raio) controla a intensidade (velocity).</li>
        <li><strong>Acordes ao Redimensionar:</strong>
          <ul>
            <li>Quando uma forma √© redimensionada significativamente (gesto de polegares).</li>
            <li><strong>Modo de Acorde (tecla 'C' para alternar):</strong>
              <ul>
                <li><strong>TRIAD:</strong> Toca um acorde de tr√™s notas (fundamental, ter√ßa, quinta da nota base da forma na escala atual).</li>
                <li><strong>VERTEX_ALL:</strong> Toca todas as notas correspondentes aos v√©rtices da forma simultaneamente, como um acorde polif√¥nico (Ex: forma de 7 lados toca 7 notas). Limitado por `maxPolyphony`.</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Distor√ß√£o da forma afeta o pitch bend.</li>
        <li>Modos Legato/Staccato (tecla 'L') e Pulso (tecla 'P').</li>
      </ul>

      <h4>Comunica√ß√£o OSC</h4>
      <p>O sistema envia mensagens OSC via WebSocket para o endere√ßo `ws://localhost:8080`. √â compat√≠vel com o script Python `osc_relay28.py` que traduz estas mensagens para UDP, permitindo a integra√ß√£o com softwares como o TouchDesigner (porta UDP padr√£o 5005).</p>
      <p>Principais mensagens OSC enviadas (al√©m das novas mencionadas em "Novidades v28"):</p>
      <ul>
        <li>`/forma/[id]/noteOn <nota> <velocidade> <canal>`</li>
        <li>`/forma/[id]/noteOff <nota> <canal>`</li>
        <li>`/forma/[id]/chord <nota1> <nota2> ...` (Envia todas as notas do acorde tocado)</li>
        <li>`/forma/[id]/sides <quantidade>`</li>
        <li>`/forma/[id]/radius <raio>`</li>
        <li>`/forma/[id]/pos <x_norm> <y_norm>`</li>
        <li>`/forma/[id]/distortion <distorcao_norm>`</li>
        <li>`/ping <timestamp>` (Heartbeat peri√≥dico)</li>
        <li>`/global/state/midiEnabled <0|1>`</li>
        <li>`/global/state/pulseMode <0|1>`</li>
        <li>`/global/state/staccatoMode <0|1>`</li>
        <li>`/global/state/vertexPullMode <0|1>`</li>
        <li>`/global/state/chordMode <"TRIAD"|"VERTEX_ALL">`</li>
        <li>`/global/state/scale <scale_name_key>`</li>
        <li>`/forma/[id]/gestureActivated <"resize"|"sides"|"pull"|"liquify"|"none">`</li>
      </ul>
      <p>Controle via OSC recebido (exemplos):</p>
      <ul>
        <li>`/global/setChordMode "TRIAD"` ou `/global/setChordMode "VERTEX_ALL"`</li>
        <li>... e outros controles para raio, lados, modos globais, etc.</li>
      </ul>
      <p>O `osc_relay28.py` agora envia uma confirma√ß√£o via WebSocket para cada mensagem OSC que ele encaminha para UDP.</p>


      <h4>Manipula√ß√£o das Formas com as M√£os</h4>
      <p>O sistema pode operar em modo de <strong>1 Pessoa</strong> ou <strong>2 Pessoas</strong> (selecion√°vel via bot√£o "Modo" ou OSC).</p>
      <ul>
        <li><strong>Modo 1 Pessoa:</strong> A pessoa controla apenas a Forma 1. A Forma 2 permanece vis√≠vel mas inativa em termos de controle por gestos e n√£o gera MIDI a partir de intera√ß√µes manuais.</li>
        <li><strong>Modo 2 Pessoas:</strong> Cada pessoa controla uma forma (Forma 1 pela primeira pessoa detectada, Forma 2 pela segunda).</li>
      </ul>
      <p>Gestos de controle (para a forma ativa):</p>
      <ul>
        <li><strong>Redimensionamento do Raio & Acorde:</strong> Polegares das duas m√£os. Dispara acorde. (Envia `/forma/[id]/gestureActivated "resize"`)</li>
        <li><strong>N√∫mero de Lados:</strong> Pin√ßa com m√£o esquerda. (Envia `/forma/[id]/gestureActivated "sides"`)</li>
        <li><strong>Distor√ß√£o (Liquify):</strong> M√£o direita pr√≥xima √† borda. (Envia `/forma/[id]/gestureActivated "liquify"`)</li>
        <li><strong>Puxar V√©rtices (tecla 'V'):</strong> Dedo indicador da m√£o direita. (Envia `/forma/[id]/gestureActivated "pull"`)</li>
      </ul>

      <h4>Teclas de Atalho</h4>
      <ul>
        <li><strong>M:</strong> Ativa/Desativa MIDI global. (Envia `/global/state/midiEnabled`)</li>
        <li><strong>P:</strong> Ativa/Desativa Modo Pulso global. (Envia `/global/state/pulseMode`)</li>
        <li><strong>L:</strong> Alterna Staccato/Legato. (Envia `/global/state/staccatoMode`)</li>
        <li><strong>V:</strong> Ativa/Desativa modo "Puxar V√©rtices". (Envia `/global/state/vertexPullMode`)</li>
        <li><strong>S:</strong> Cicla escalas musicais. (Envia `/global/state/scale`)</li>
        <li><strong>N:</strong> Cicla modos de gera√ß√£o de nota (Sequencial, Arpejo - agora acorde, etc.).</li>
        <li><strong>C:</strong> Alterna Modo de Acorde (TRIAD / VERTEX_ALL). (Envia `/global/state/chordMode`)</li>
        <li><strong>Bot√£o "Modo":</strong> Alterna opera√ß√£o 1 Pessoa / 2 Pessoas.</li>
      </ul>

      <div class="modal-footer">
        <p>¬© Leonardo Carvalho ‚Äî 2025</p>
        <p><a href="https://www.instagram.com/leocarvalho.exe?igsh=MXg5bHN0Zm12YnhocA==" target="_blank">@leocarvalho.exe</a></p>
      </div>
    </div>
  </div>

  <div id="settingsModal">
    <div class="modal-content">
      <span id="closeSettingsModal">&times;</span>
      <h3>Configura√ß√µes MIDI</h3>
      <label for="midiOutputSelect">Porta de Sa√≠da MIDI:</label>
      <select id="midiOutputSelect">
        <!-- Options will be populated by JavaScript -->
      </select>
      <!-- Add more settings here if needed in the future -->
       <div class="modal-footer">
        <p>As configura√ß√µes s√£o aplicadas em tempo real.</p>
      </div>
    </div>
  </div>

  <video id="video" style="display:none;" playsinline></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/osc-js/lib/osc.min.js"></script>
  <script src="main28.js" defer></script>
  <div id="hud"></div>
</body>
</html>
